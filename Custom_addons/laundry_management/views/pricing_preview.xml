<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="pricing_preview" name="Pricing Preview">
    <t t-call="website.layout">
      <div class="container py-5">
        <!-- Preview Header -->
        <div class="alert alert-warning mb-4" role="alert">
          <div class="d-flex align-items-center">
            <i class="fa fa-eye fa-2x me-3"></i>
            <div>
              <h4 class="alert-heading mb-1">Pricing Preview Mode</h4>
              <p class="mb-0">This is how customers will see the pricing for <strong t-esc="service.name"/>. 
              Items are marked as <span class="badge bg-warning text-dark">MODIFIED</span> if changed or <span class="badge bg-info">NEW</span> if not yet published.</p>
            </div>
          </div>
        </div>

        <!-- Success/Error Messages -->
        <div t-if="success_message" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fa fa-check-circle me-2"></i>
          <span t-esc="success_message"/>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <div t-if="error_message" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fa fa-exclamation-circle me-2"></i>
          <span t-esc="error_message"/>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Service Header -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-2">
                <img t-if="service.image" 
                     t-attf-src="/web/image/laundry.service/{{ service.id }}/image"
                     class="img-fluid rounded-circle" 
                     style="width: 80px; height: 80px; object-fit: cover;" 
                     alt="Service Image"/>
                <div t-else="" class="bg-light rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 80px; height: 80px;">
                  <i class="fa fa-image fa-2x text-muted"></i>
                </div>
              </div>
              <div class="col-md-10">
                <h2 class="mb-1" t-esc="service.name"/>
                <p t-if="service.tagline" class="text-muted fst-italic mb-2" t-esc="service.tagline"/>
                <p t-if="service.overview" class="mb-0" t-esc="service.overview"/>
              </div>
            </div>
          </div>
        </div>

        <!-- Pricing Table -->
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">
              <i class="fa fa-tags me-2"></i>Pricing Information
            </h3>
          </div>
          <div class="card-body p-0">
            <t t-if="pricing_data['services'] and pricing_data['services'][0]['categories']">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Category</th>
                    <th>Item</th>
                    <th class="text-end">Price</th>
                    <th class="text-center">Status</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="pricing_data['services'][0]['categories']" t-as="category">
                    <t t-foreach="category['products']" t-as="product">
                      <tr>
                        <td t-if="product_index == 0" t-attf-rowspan="{{ len(category['products']) }}" 
                            class="align-middle fw-bold text-primary">
                          <i class="fa fa-folder me-2"></i>
                          <t t-esc="category['name']"/>
                        </td>
                        <td>
                          <t t-esc="product['name']"/>
                          <t t-if="product.get('name_changed')">
                            <br/>
                            <small class="text-muted">
                              Published: <span class="text-warning" t-esc="product.get('published_name')"/>
                            </small>
                          </t>
                        </td>
                        <td class="text-end fw-bold text-success">
                          <t t-set="currency" t-value="pricing_data['services'][0].get('currency', {})"/>
                          <t t-if="currency.get('position') == 'before'">
                            <t t-esc="currency.get('symbol', 'AED')"/> <t t-esc="'%.2f' % product['price']"/>
                          </t>
                          <t t-else="">
                            <t t-esc="'%.2f' % product['price']"/> <t t-esc="currency.get('symbol', 'AED')"/>
                          </t>
                          <t t-if="product.get('price_changed')">
                            <br/>
                            <small class="text-muted">
                              Published: <span class="text-warning">
                                <t t-if="currency.get('position') == 'before'">
                                  <t t-esc="currency.get('symbol', 'AED')"/> <t t-esc="'%.2f' % product.get('published_price', 0)"/>
                                </t>
                                <t t-else="">
                                  <t t-esc="'%.2f' % product.get('published_price', 0)"/> <t t-esc="currency.get('symbol', 'AED')"/>
                                </t>
                              </span>
                            </small>
                          </t>
                        </td>
                        <td class="text-center">
                          <t t-if="product.get('change_status') == 'new'">
                            <span class="badge bg-info">
                              <i class="fa fa-plus-circle me-1"></i>NEW
                            </span>
                          </t>
                          <t t-elif="product.get('change_status') == 'modified'">
                            <span class="badge bg-warning text-dark">
                              <i class="fa fa-edit me-1"></i>MODIFIED
                            </span>
                            <br/>
                            <small class="text-muted">
                              <t t-if="product.get('price_changed')">Price</t>
                              <t t-if="product.get('price_changed') and product.get('name_changed')"> &amp; </t>
                              <t t-if="product.get('name_changed')">Name</t>
                            </small>
                          </t>
                          <t t-else="">
                            <span class="badge bg-success">
                              <i class="fa fa-check-circle me-1"></i>PUBLISHED
                            </span>
                          </t>
                        </td>
                      </tr>
                    </t>
                  </t>
                </tbody>
              </table>
            </t>
            <t t-else="">
              <div class="text-center py-5">
                <i class="fa fa-info-circle fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Pricing Information</h4>
                <p class="text-muted">No products found for this service's categories.</p>
              </div>
            </t>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4">
          <div class="col-md-12">
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                  <i class="fa fa-cogs me-2"></i>Pricing Control Actions
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <span class="badge fs-6" t-attf-class="bg-{{ 'success' if service.is_pricing_published else 'secondary' }}">
                          <i t-attf-class="fa {{ 'fa-globe' if service.is_pricing_published else 'fa-eye-slash' }} me-1"></i>
                          <span t-if="service.is_pricing_published">PUBLISHED</span>
                          <span t-else="">UNPUBLISHED</span>
                        </span>
                      </div>
                      <div>
                        <strong>Status:</strong> 
                        <span t-if="service.is_pricing_published">
                          Pricing is live and visible to customers
                        </span>
                        <span t-else="">
                          Pricing is hidden from customers
                        </span>
                        <br/>
                        <small class="text-muted">
                          <span t-if="service.pricing_last_updated">
                            Last updated: <t t-esc="service.pricing_last_updated"/>
                          </span>
                          <span t-else="">Never published</span>
                          <span t-if="service.pricing_pending_changes" class="ms-2 text-warning">
                            <i class="fa fa-exclamation-triangle"></i> Has pending changes
                          </span>
                        </small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex gap-2 justify-content-end">
                      <button type="button" class="btn btn-secondary" onclick="window.close()">
                        <i class="fa fa-times me-2"></i>Close
                      </button>
                      
                      <!-- Direct form submission to controller route -->
                      <form method="post" t-attf-action="/laundry/republish_pricing/{{service.id}}" style="display: inline;">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <button type="submit" class="btn btn-success">
                          <i class="fa fa-refresh me-2"></i>
                          <span t-if="service.is_pricing_published">Republish Changes</span>
                          <span t-else="">Publish Pricing</span>
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </t>
  </template>
</odoo>
